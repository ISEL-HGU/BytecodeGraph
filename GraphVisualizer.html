<!DOCTYPE html>
<html>
<head>
    <title>Bytecode Graph Visualizer (File Load)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; background: #f8f9fa; }
        #toolbar { padding: 15px 20px; background: #ffffff; border-bottom: 1px solid #dee2e6; display: flex; gap: 20px; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 10; }
        #cy { flex: 1; background: #ffffff; width: 100%; }
        .filter-group { display: flex; gap: 10px; align-items: center; padding-left: 15px; border-left: 1px solid #ccc; }
        label { font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        input[type="file"] { font-size: 13px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body>

<div id="toolbar">
    <input type="file" id="file-input" accept=".json">

    <div class="filter-group">
        <strong>Edges:</strong>
        <label><span class="legend-dot" style="background:#767061"></span><input type="checkbox" class="filter" value="cfg" checked> CFG</label>
        <label><span class="legend-dot" style="background:#00c4ff"></span><input type="checkbox" class="filter" value="dfg" checked> DFG</label>
        <label><span class="legend-dot" style="background:#b453f5"></span><input type="checkbox" class="filter" value="cdg" checked> CDG</label>
        <label><span class="legend-dot" style="background:#6dcd00"></span><input type="checkbox" class="filter" value="ddg" checked> DDG</label>
        <label><span class="legend-dot" style="background:#e52c1a"></span><input type="checkbox" class="filter" value="ex" checked> EX</label>
    </div>
</div>

<div id="cy"></div>

<script>
    let cy;

    document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                renderGraph(data);
            } catch (err) {
                alert("JSON 파일을 읽는 중 오류가 발생했습니다.");
            }
        };
        reader.readAsText(file);
    });

    function renderGraph(data) {
        const elements = [];

        // Nodes
        data.nodes.forEach(node => {
            elements.push({
                data: {
                    id: node.offset.toString(),
                    label: `[${node.offset}]\n${node.mnemonic}\n${node.operands}`
                }
            });
        });

        // Edges Helper
        const addEdges = (edgeList, type) => {
            if (!edgeList) return;
            edgeList.forEach((edge, index) => {
                elements.push({
                    data: {
                        id: `${type}-${index}`,
                        source: edge.src.toString(),
                        target: edge.dst.toString()
                    },
                    classes: type
                });
            });
        };

        addEdges(data.edges.cfg, 'cfg');
        addEdges(data.edges.dfg, 'dfg');
        addEdges(data.edges.cdg, 'cdg');
        addEdges(data.edges.ddg, 'ddg');
        addEdges(data.edges.ex, 'ex');

        cy = cytoscape({
            container: document.getElementById('cy'),
            elements: elements,
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'text-wrap': 'wrap',
                        'background-color': '#ffffff',
                        'border-width': 1.5,
                        'border-color': '#333',
                        'width': '100px',
                        'height': '60px',
                        'shape': 'round-rectangle',
                        'font-size': '11px',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'color': '#2c3e50'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'curve-style': 'bezier',
                        'target-arrow-shape': 'triangle',
                        'arrow-scale': 1.2
                    }
                },
                { selector: '.cfg', style: { 'line-color': '#767061', 'target-arrow-color': '#767061' } },
                { selector: '.dfg', style: { 'line-color': '#00c4ff', 'target-arrow-color': '#00c4ff', 'line-style': 'dashed' } },
                { selector: '.cdg', style: { 'line-color': '#b453f5', 'target-arrow-color': '#b453f5' } },
                { selector: '.ddg', style: { 'line-color': '#6dcd00', 'target-arrow-color': '#6dcd00', 'line-style': 'dashed' } },
                { selector: '.ex', style: { 'line-color': '#e52c1a', 'target-arrow-color': '#e52c1a' } }
            ],
            layout: {
                name: 'dagre', // 위에서 아래로 흐르는 계층 구조
                rankDir: 'TB',
                nodeSep: 50,
                rankSep: 100
            }
        });

        updateVisibility();
    }

    function updateVisibility() {
        if (!cy) return;
        document.querySelectorAll('.filter').forEach(checkbox => {
            const type = checkbox.value;
            cy.edges(`.${type}`).style('display', checkbox.checked ? 'element' : 'none');
        });
    }

    document.querySelectorAll('.filter').forEach(cb => {
        cb.addEventListener('change', updateVisibility);
    });
</script>
</body>
</html>